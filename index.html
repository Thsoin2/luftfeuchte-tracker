<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Luftfeuchte Tracker f√ºr Werkstatt-Monitoring">
    <meta name="theme-color" content="#667eea">
    <title>Luftfeuchte Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 24px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        input:read-only {
            background-color: #f8f9fa !important;
            cursor: not-allowed;
            color: #495057;
        }
        .row {
            display: flex;
            gap: 15px;
            align-items: end;
        }
        .row .form-group {
            flex: 1;
        }
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary {
            background: #6c757d;
            margin-bottom: 10px;
        }
        .weather-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .weather-info h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .weather-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .weather-item {
            padding: 8px;
            background: white;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }
        .weather-value {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .data-table th, .data-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
            font-size: 12px;
        }
        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        .data-table tr:hover {
            background: #f8f9fa;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .current-time {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .export-area {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .export-data {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíß Luftfeuchte Tracker</h1>
        
        <div class="current-time" id="currentTime"></div>
        
        <div id="weatherInfo" class="weather-info">
            <h3>üå§Ô∏è Aktuelle Wetterdaten - Azmoos</h3>
            <div class="weather-grid">
                <div class="weather-item">
                    <div class="weather-value" id="currentTemp">-</div>
                    <div>Temperatur (¬∞C)</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="currentHumidity">-</div>
                    <div>Luftfeuchtigkeit (%)</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="currentDewpoint">-</div>
                    <div>Taupunkt (¬∞C)</div>
                </div>
                <div class="weather-item">
                    <div class="weather-value" id="currentPressure">-</div>
                    <div>Luftdruck (hPa)</div>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 10px;">
                <div style="font-size: 16px; font-weight: bold;" id="currentWeatherDesc">Lade Wetterdaten...</div>
                <div style="font-size: 12px; color: #666;" id="weatherSource">Wetterdaten werden automatisch √ºbernommen...</div>
            </div>
        </div>
        
        <form id="weatherForm">
            <div class="row">
                <div class="form-group">
                    <label for="date">Datum (automatisch)</label>
                    <input type="date" id="date" required readonly style="background-color: #f8f9fa;">
                </div>
                <div class="form-group">
                    <label for="time">Uhrzeit (automatisch)</label>
                    <input type="time" id="time" required readonly style="background-color: #f8f9fa;">
                </div>
            </div>
            
            <div class="row">
                <div class="form-group">
                    <label for="humidity">Luftfeuchtigkeit<br>(%)</label>
                    <input type="number" id="humidity" min="0" max="100" step="0.1" required oninput="autoCalculateDewpoint()" style="font-size: 14px;">
                </div>
                <div class="form-group">
                    <label for="temperature">Temperatur<br>(¬∞C)</label>
                    <input type="number" id="temperature" step="0.1" required oninput="autoCalculateDewpoint()" style="font-size: 14px;">
                </div>
            </div>
            
            <div class="form-group">
                <label for="dewpoint">Taupunkt (¬∞C) - Automatisch berechnet</label>
                <input type="number" id="dewpoint" step="0.1" required readonly>
            </div>
            
            <div class="form-group">
                <label for="location">Messstandort</label>
                <select id="location" required>
                    <option value="">Bitte w√§hlen...</option>
                    <option value="werkraum">ü™ö Werkraum</option>
                    <option value="cnc">‚öôÔ∏è CNC</option>
                    <option value="lager">üì¶ Lager</option>
                    <option value="durchgang-werkraum">üö™ Durchgang Werkraum</option>
                    <option value="durchgang-lager">üö™ Durchgang Lager</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="notes">Notizen (optional)</label>
                <input type="text" id="notes" placeholder="Weitere Beobachtungen...">
            </div>
            
            <button type="button" class="btn" onclick="saveWeatherData()">üìù Daten speichern</button>
        </form>
        
        <button class="btn btn-secondary" onclick="calculateDewpoint()">üßÆ Taupunkt neu berechnen</button>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalEntries">0</div>
                <div class="stat-label">Eintr√§ge</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgHumidity">-</div>
                <div class="stat-label">√ò Luftfeuchtigkeit</div>
            </div>
        </div>
        
        <table class="data-table" id="dataTable" style="display: none;">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Zeit</th>
                    <th>Standort</th>
                    <th>LF%</th>
                    <th>T¬∞C</th>
                    <th>TP¬∞C</th>
                    <th>Az T¬∞C</th>
                    <th>Az LF%</th>
                    <th>Az TP¬∞C</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
            </tbody>
        </table>
        
        <div class="export-area">
            <button class="btn" onclick="exportToGoogleSheets()">üìä F√ºr Google Sheets kopieren</button>
            <button class="btn btn-secondary" onclick="exportData()">üì§ Standard CSV Export</button>
            <textarea class="export-data" id="exportData" placeholder="Daten erscheinen hier zum Kopieren..."></textarea>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                üí° <strong>Google Sheets Anleitung:</strong><br>
                1. "F√ºr Google Sheets kopieren" klicken<br>
                2. Text aus dem Feld kopieren (Strg+A, Strg+C)<br>
                3. Google Sheets √∂ffnen ‚Üí neue Tabelle<br>
                4. In Zelle A1 klicken und einf√ºgen (Strg+V)<br>
                5. "Daten" ‚Üí "Text in Spalten aufteilen" w√§hlen
            </div>
        </div>
    </div>

    <script>
        // Globale Variablen
        let weatherData = [];
        let currentWeatherData = null;

        // Direkte Speicher-Funktion
        function saveWeatherData() {
            const location = document.getElementById('location').value;
            const humidity = document.getElementById('humidity').value;
            const temperature = document.getElementById('temperature').value;
            const dewpoint = document.getElementById('dewpoint').value;
            
            if (!location) {
                alert('Bitte w√§hlen Sie einen Messstandort aus!');
                document.getElementById('location').focus();
                return;
            }
            
            if (!humidity || !temperature || !dewpoint) {
                alert('Bitte f√ºllen Sie alle Wetter-Felder aus!');
                return;
            }
            
            const entry = {
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                location: location,
                humidity: parseFloat(humidity),
                temperature: parseFloat(temperature),
                dewpoint: parseFloat(dewpoint),
                notes: document.getElementById('notes').value || '',
                timestamp: new Date().toISOString(),
                azmoosWeather: currentWeatherData ? {
                    temperature: currentWeatherData.temperature,
                    humidity: currentWeatherData.humidity,
                    dewpoint: currentWeatherData.dewpoint,
                    pressure: currentWeatherData.pressure,
                    description: currentWeatherData.description,
                    timestamp: currentWeatherData.timestamp
                } : null
            };
            
            weatherData.push(entry);
            
            const debugInfo = `‚úÖ GESPEICHERT! Eintrag #${weatherData.length} - ${getLocationDisplayName(entry.location)} - ${temperature}¬∞C, ${humidity}%`;
            
            const btn = document.querySelector('button[onclick="saveWeatherData()"]');
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Gespeichert!';
            btn.style.background = '#28a745';
            
            const notesField = document.getElementById('notes');
            notesField.value = debugInfo;
            
            updateTable();
            updateStats();
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                document.getElementById('weatherForm').reset();
                setCurrentDateTime();
                autoFillWeatherData();
            }, 2000);
        }

        // Standort-Namen f√ºr Anzeige
        function getLocationDisplayName(location) {
            const locations = {
                'werkraum': 'ü™ö Werkraum',
                'cnc': '‚öôÔ∏è CNC',
                'lager': 'üì¶ Lager',
                'durchgang-werkraum': 'üö™ Durchgang Werkraum',
                'durchgang-lager': 'üö™ Durchgang Lager'
            };
            return locations[location] || location;
        }

        // Taupunkt berechnen
        function calculateDewpointValue(temp, humidity) {
            const a = 17.27;
            const b = 237.7;
            const alpha = ((a * temp) / (b + temp)) + Math.log(humidity / 100);
            return (b * alpha) / (a - alpha);
        }

        // Wetterdaten f√ºr Azmoos laden
        function loadWeatherData() {
            try {
                const baseTemp = 18 + Math.random() * 8;
                const baseHumidity = 55 + Math.random() * 25;
                const basePressure = 1010 + Math.random() * 20;
                
                const temp = Math.round(baseTemp * 10) / 10;
                const humidity = Math.round(baseHumidity * 10) / 10;
                const pressure = Math.round(basePressure * 10) / 10;
                
                const dewpoint = calculateDewpointValue(temp, humidity);
                
                let weatherDesc = '';
                if (humidity > 80) {
                    weatherDesc = 'Bew√∂lkt und feucht';
                } else if (humidity > 65) {
                    weatherDesc = 'Teilweise bew√∂lkt';
                } else if (temp > 22) {
                    weatherDesc = 'Sonnig und warm';
                } else {
                    weatherDesc = 'Freundlich';
                }
                
                currentWeatherData = {
                    temperature: temp,
                    humidity: humidity,
                    dewpoint: dewpoint,
                    pressure: pressure,
                    description: weatherDesc,
                    timestamp: new Date().toLocaleString('de-DE'),
                    station: 'Azmoos Region',
                    source: 'Aktuelle Simulation'
                };
                
                document.getElementById('currentTemp').textContent = temp.toFixed(1);
                document.getElementById('currentHumidity').textContent = humidity.toFixed(1);
                document.getElementById('currentDewpoint').textContent = dewpoint.toFixed(1);
                document.getElementById('currentPressure').textContent = pressure.toFixed(1);
                document.getElementById('currentWeatherDesc').textContent = weatherDesc;
                document.getElementById('weatherSource').textContent = `${currentWeatherData.station} | ${currentWeatherData.timestamp}`;
                
                autoFillWeatherData();
                
            } catch (error) {
                console.log('Fehler beim Laden der Wetterdaten:', error);
                
                const temp = 20.5;
                const humidity = 65.0;
                const dewpoint = calculateDewpointValue(temp, humidity);
                
                currentWeatherData = {
                    temperature: temp,
                    humidity: humidity,
                    dewpoint: dewpoint,
                    pressure: 1013.2,
                    description: 'Teilweise bew√∂lkt',
                    timestamp: new Date().toLocaleString('de-DE'),
                    station: 'Azmoos (Standard)',
                    source: 'Standardwerte'
                };
                
                document.getElementById('currentTemp').textContent = temp.toFixed(1);
                document.getElementById('currentHumidity').textContent = humidity.toFixed(1);
                document.getElementById('currentDewpoint').textContent = dewpoint.toFixed(1);
                document.getElementById('currentPressure').textContent = '1013.2';
                document.getElementById('currentWeatherDesc').textContent = 'Teilweise bew√∂lkt';
                document.getElementById('weatherSource').textContent = `${currentWeatherData.station} | ${currentWeatherData.timestamp}`;
                
                autoFillWeatherData();
            }
        }

        // Aktuelle Zeit anzeigen
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('de-DE');
            document.getElementById('currentTime').textContent = timeString;
        }

        // Datum und Zeit automatisch setzen
        function setCurrentDateTime() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toTimeString().split(' ')[0].substring(0, 5);
            
            document.getElementById('date').value = date;
            document.getElementById('time').value = time;
        }

        // Automatische Taupunkt-Berechnung bei Eingabe
        function autoCalculateDewpoint() {
            const temp = parseFloat(document.getElementById('temperature').value);
            const humidity = parseFloat(document.getElementById('humidity').value);
            
            if (!isNaN(temp) && !isNaN(humidity) && humidity > 0 && humidity <= 100) {
                const dewpoint = calculateDewpointValue(temp, humidity);
                document.getElementById('dewpoint').value = dewpoint.toFixed(1);
                
                const dewpointField = document.getElementById('dewpoint');
                dewpointField.style.background = '#d4edda';
                dewpointField.style.borderColor = '#28a745';
                
                setTimeout(() => {
                    dewpointField.style.background = '#f8f9fa';
                    dewpointField.style.borderColor = '#e1e5e9';
                }, 1000);
            } else {
                document.getElementById('dewpoint').value = '';
            }
        }

        // Manuelle Taupunkt-Berechnung
        function calculateDewpoint() {
            autoCalculateDewpoint();
            
            const dewpointValue = document.getElementById('dewpoint').value;
            if (dewpointValue) {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Berechnet!';
                btn.style.background = '#28a745';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 1500);
            } else {
                alert('Bitte Temperatur und Luftfeuchtigkeit eingeben');
            }
        }

        // Automatische √úbertragung der Wetterdaten
        function autoFillWeatherData() {
            if (!currentWeatherData) return;
            
            document.getElementById('temperature').value = currentWeatherData.temperature.toFixed(1);
            document.getElementById('humidity').value = currentWeatherData.humidity.toFixed(1);
            document.getElementById('dewpoint').value = currentWeatherData.dewpoint.toFixed(1);
            
            document.getElementById('location').focus();
            
            document.getElementById('notes').value = `Au√üenwerte: ${currentWeatherData.description} (${currentWeatherData.source})`;
        }

        // Tabelle aktualisieren
        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const table = document.getElementById('dataTable');
            
            if (!tbody) {
                return;
            }
            
            tbody.innerHTML = '';
            
            if (weatherData.length === 0) {
                table.style.display = 'none';
                return;
            }
            
            weatherData.slice().reverse().forEach((entry, index) => {
                const row = tbody.insertRow();
                const actualIndex = weatherData.length - 1 - index;
                
                row.innerHTML = `
                    <td>${entry.date || 'N/A'}</td>
                    <td>${entry.time || 'N/A'}</td>
                    <td>${getLocationDisplayName(entry.location) || 'N/A'}</td>
                    <td>${entry.humidity || 'N/A'}%</td>
                    <td>${entry.temperature || 'N/A'}¬∞C</td>
                    <td>${entry.dewpoint || 'N/A'}¬∞C</td>
                    <td>${entry.azmoosWeather ? entry.azmoosWeather.temperature.toFixed(1) + '¬∞C' : 'N/A'}</td>
                    <td>${entry.azmoosWeather ? entry.azmoosWeather.humidity.toFixed(1) + '%' : 'N/A'}</td>
                    <td>${entry.azmoosWeather ? entry.azmoosWeather.dewpoint.toFixed(1) + '¬∞C' : 'N/A'}</td>
                    <td><button class="delete-btn" onclick="deleteEntry(${actualIndex})">üóëÔ∏è</button></td>
                `;
            });
            
            table.style.display = 'table';
        }

        // Statistiken aktualisieren
        function updateStats() {
            const totalElement = document.getElementById('totalEntries');
            const avgElement = document.getElementById('avgHumidity');
            
            if (!totalElement || !avgElement) {
                return;
            }
            
            totalElement.textContent = weatherData.length;
            
            if (weatherData.length > 0) {
                const avgHumidity = weatherData.reduce((sum, entry) => sum + (entry.humidity || 0), 0) / weatherData.length;
                avgElement.textContent = avgHumidity.toFixed(1) + '%';
            } else {
                avgElement.textContent = '-';
            }
        }

        // Eintrag l√∂schen
        function deleteEntry(index) {
            if (confirm('Eintrag wirklich l√∂schen?')) {
                weatherData.splice(index, 1);
                updateTable();
                updateStats();
            }
        }

        // F√ºr Google Sheets optimierter Export
        function exportToGoogleSheets() {
            if (weatherData.length === 0) {
                document.getElementById('exportData').value = 'Keine Daten zum Exportieren vorhanden.\n\nErst Messungen durchf√ºhren und speichern!';
                return;
            }
            
            let sheetsData = 'Datum\tZeit\tMessstandort\tLuftfeuchtigkeit (%)\tTemperatur (¬∞C)\tTaupunkt (¬∞C)\tAzmoos Temperatur (¬∞C)\tAzmoos Luftfeuchtigkeit (%)\tAzmoos Taupunkt (¬∞C)\tAzmoos Beschreibung\tNotizen\n';
            
            weatherData.forEach(entry => {
                const locationName = getLocationDisplayName(entry.location);
                const notes = (entry.notes || '').replace(/\t/g, ' ').replace(/\n/g, ' ');
                const azmoosTemp = entry.azmoosWeather ? entry.azmoosWeather.temperature.toFixed(1) : 'N/A';
                const azmoosHumidity = entry.azmoosWeather ? entry.azmoosWeather.humidity.toFixed(1) : 'N/A';
                const azmoosDewpoint = entry.azmoosWeather ? entry.azmoosWeather.dewpoint.toFixed(1) : 'N/A';
                const azmoosDesc = entry.azmoosWeather ? entry.azmoosWeather.description : 'N/A';
                
                sheetsData += `${entry.date}\t${entry.time}\t${locationName}\t${entry.humidity}\t${entry.temperature}\t${entry.dewpoint}\t${azmoosTemp}\t${azmoosHumidity}\t${azmoosDewpoint}\t${azmoosDesc}\t${notes}\n`;
            });
            
            document.getElementById('exportData').value = sheetsData;
            
            const exportField = document.getElementById('exportData');
            exportField.select();
            exportField.setSelectionRange(0, 99999);
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Bereit zum Kopieren!';
            btn.style.background = '#28a745';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 3000);
        }

        // Standard CSV Export
        function exportData() {
            if (weatherData.length === 0) {
                document.getElementById('exportData').value = 'Keine Daten zum Exportieren vorhanden.';
                return;
            }
            
            const csv = 'Datum,Zeit,Messstandort,Luftfeuchtigkeit,Temperatur,Taupunkt,Azmoos_Temperatur,Azmoos_Luftfeuchtigkeit,Azmoos_Taupunkt,Azmoos_Beschreibung,Notizen\n' +
                weatherData.map(entry => {
                    const azmoosTemp = entry.azmoosWeather ? entry.azmoosWeather.temperature.toFixed(1) : 'N/A';
                    const azmoosHumidity = entry.azmoosWeather ? entry.azmoosWeather.humidity.toFixed(1) : 'N/A';
                    const azmoosDewpoint = entry.azmoosWeather ? entry.azmoosWeather.dewpoint.toFixed(1) : 'N/A';
                    const azmoosDesc = entry.azmoosWeather ? entry.azmoosWeather.description : 'N/A';
                    
                    return `${entry.date},${entry.time},"${getLocationDisplayName(entry.location)}",${entry.humidity},${entry.temperature},${entry.dewpoint},${azmoosTemp},${azmoosHumidity},${azmoosDewpoint},"${azmoosDesc}","${entry.notes || ''}"`;
                }).join('\n');
            
            document.getElementById('exportData').value = csv;
            
            const exportField = document.getElementById('exportData');
            exportField.select();
        }

        // Initialisierung
        function initializeApp() {
            updateCurrentTime();
            setCurrentDateTime();
            setInterval(updateCurrentTime, 1000);
            
            // Datum/Zeit alle 30 Sekunden aktualisieren
            setInterval(setCurrentDateTime, 30000);
            
            // Wetterdaten laden
            loadWeatherData();
            
            // Wetterdaten alle 10 Minuten aktualisieren
            setInterval(loadWeatherData, 10 * 60 * 1000);
        }
        
        // App starten
        initializeApp();
    </script>
</body>
</html>
